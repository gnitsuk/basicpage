<!DOCTYPE html>
<html lang="en">
  <head>

    <title>mobeon</title>

    <script type="text/javascript">

        var OP_CODES = { "NUM_OTHER_CLIENTS": 1 };
        var MODES = { "STARTING": 0,  "RUNNING":1 };
        var AWAITING_EVENTS = {"NONE":0, "ACCEPTANCE":1, "CLIENT_LIST":2};

        this.m_szName = "";
        this.m_nameButton = null;
        this.m_nameTextBox = null
        this.m_nButtonWidth = 100;
        this.m_nButtonHeight = 30;
        this.m_nTextboxWidth = 200;
        this.m_nTextboxHeight = 20;
        this.m_sendTextArea = null;
        this.m_mode = MODES.STARTING;
        this.m_arrClientButtons = [];
        this.m_receiveTextArea = null;
        this.m_websocketConnection = null;;
        this.m_awaitingEvent = AWAITING_EVENTS.NONE;

        function CreateTextbox(x, y, width, height, parentElement, szInnerHTML, szID)
        {
            var newTextbox = document.createElement("input");

            newTextbox.id = szID;
            newTextbox.style.position = "absolute";
            newTextbox.style.left = x.toString() + 'px';
            newTextbox.style.top = y.toString() + 'px';
            newTextbox.style.width = width.toString() + 'px';
            newTextbox.style.height = height.toString() + 'px';
            newTextbox.value = szInnerHTML;
            newTextbox.style.textAlign = "center";
            parentElement.appendChild(newTextbox);

            return newTextbox;
        }

        function CreateTextArea(x, y, width, height, parentElement, szInnerHTML, szID)
        {
            var newTextArea = document.createElement("textarea");

            newTextArea.id = szID;
            newTextArea.style.position = "absolute";
            newTextArea.style.left = x.toString() + 'px';
            newTextArea.style.top = y.toString() + 'px';
            newTextArea.style.right = y.toString() + 'px';
            newTextArea.style.width = width.toString() + 'px';
            newTextArea.style.height = height.toString() + 'px';
            newTextArea.type = "text";
            newTextArea.value = szInnerHTML;
            newTextArea.style.resize = "none";
            parentElement.appendChild(newTextArea);

            return newTextArea;
        }

        function CreateButton(x, y, width, height, parentElement, onClickFunction, szInnerHTML, szID)
        {
            var newButton = document.createElement("input");

            newButton.id = szID;
            newButton.style.position = "absolute";
            newButton.style.left = x.toString() + 'px';
            newButton.style.top = y.toString() + 'px';
            newButton.style.width = width.toString() + 'px';
            newButton.style.height = height.toString() + 'px';
            newButton.type = "button";
            newButton.value = szInnerHTML;
            newButton.onclick = onClickFunction;
            parentElement.appendChild(newButton);
    
            return newButton;
        }

        function OnWebSocketBinConnectionMessage(event)
        {
            if (event.data.toString() != "[object ArrayBuffer]")
            {
                this.m_parent.ProcessIncomingASCIIMessage(event.data.toString());
            }
            else
            {
                this.m_parent.ProcessIncomingBinaryMessage(event.data);
            }
        }

        function ProcessIncomingBinaryMessage(data)
        {
            var dataview = new DataView(data);
                
            var nOpCode = dataview.getInt32(0, true);
                
            if (nOpCode == OP_CODES.NUM_OTHER_CLIENTS)
            {
                var nNumClients = dataview.getInt32(4, true);

                for(var nClient = 0; nClient < nNumClients; nClient++)
                {
                    this.AddClientButton(false);
                }

                this.LayoutControls();
            }
        }

        function ProcessIncomingASCIIMessage(szText)
        {
            if (szText.indexOf("Server connection accepted") >= 0)
            {
                document.title = szText;

                this.StartAwaitingAcceptance();
            }
            else
            {
                if(this.m_awaitingEvent = AWAITING_EVENTS.ACCEPTANCE)
                {
                    this.m_receiveTextArea.value = szText;

                    this.m_awaitingEvent = AWAITING_EVENTS.CLIENT_LIST;

                    var buffer = new ArrayBuffer(4);
                    var dataview = new DataView(buffer);

                    dataview.setInt32(0, 1, true); // 1 = Return Client Names
        
                    this.m_websocketConnection.send(buffer);
                }
            }
        }

        function StartAwaitingAcceptance()
        {
            this.m_awaitingEvent = AWAITING_EVENTS.ACCEPTANCE;

            this.m_websocketConnection.send("Name = " + this.m_szName);
        }

        function AddClientButton(bLayoutControls)
        {
            var szTextID = "Button " + this.m_arrClientButtons.length.toString();

            this.m_arrClientButtons.push(CreateButton(100,100,this.m_nButtonWidth,this.m_nButtonHeight,document.body,this.OnButtonClick, szTextID, szTextID));

            var nID = this.m_arrClientButtons.length - 1;

            this.m_arrClientButtons[nID].m_parent = this;
            this.m_arrClientButtons[nID].m_clientID = nID;

            if(bLayoutControls)
            {
                LayoutControls();
            }
        }

        function OnButtonClick()
        {
            
        }

        function OnWebSocketBinConnectionClose()
        {
            this.m_parent.m_websocketConnection = null;

            //alert("WS CLOSED");
        }

        function OnWebSocketBinConnectionOpen()
        {
        }

        function OnWebSocketConnectionError(error)
        {
            //alert("Websocket Error");
        }

        function GetWindowInnerWidth()
        {
            if(window.innerWidth)
            {
                  var innerWidth = window.innerWidth;
            }
            else if(document.documentElement)
            {
                  var innerWidth = document.documentElement.clientWidth;
            }
            else
            {
                  var innerWidth = document.body.clientWidth;
            }

            return innerWidth;
        }

        function GetWindowInnerHeight()
        {
            if(window.innerHeight)
            {
                  var innerHeight = window.innerHeight;
            }
            else if(document.documentElement)
            {
                  var innerHeight = document.documentElement.clientHeight;
            }
            else
            {
                  var innerHeight = document.body.clientHeight;
            }

            return innerHeight;
        }

        function LayoutControls()
        {
            var nBorder = 10;
            var nHalfBorder = nBorder / 2;
            var nTwiceBorder = 2 * nBorder;
            var nThriceBorder = 3 * nBorder;
            var screenWidth = GetWindowInnerWidth();
            var screenHeight = GetWindowInnerHeight();
            var nTextAreaWidth = (screenWidth - nThriceBorder) / 2;
            var receiveTextAreaLeft = nTwiceBorder + nTextAreaWidth;
            var nTextAreaHeight = screenHeight / 3;
        
            this.m_sendTextArea.style.left = nHalfBorder.toString() + "px";
            this.m_sendTextArea.style.width = nTextAreaWidth.toString() + "px";
            this.m_sendTextArea.style.height = nTextAreaHeight.toString() + "px";

            this.m_receiveTextArea.style.left = receiveTextAreaLeft.toString() + "px";
            this.m_receiveTextArea.style.width = nTextAreaWidth.toString() + "px";
            this.m_receiveTextArea.style.height = nTextAreaHeight.toString() + "px";

            var buttonRow1Top = nThriceBorder + nTextAreaHeight;
        
            for(var nButton = 0; nButton < this.m_arrClientButtons.length; nButton++)
            {
                var nButtonLeft = nThriceBorder + nButton * (this.m_nButtonWidth + nBorder);

                this.m_arrClientButtons[nButton].style.top = buttonRow1Top.toString() + "px";
                this.m_arrClientButtons[nButton].style.left = nButtonLeft.toString() + "px";
            }
        }

        function CreateControls()
        {
            this.m_sendTextArea = CreateTextArea(10, 10, 400, 100, document.body, "", "SentMessagesTextArea");
            this.m_receiveTextArea = CreateTextArea(10, 10, 400, 100, document.body, "", "ReceiveMessagesTextArea");

            LayoutControls();
        }

        function LayoutUserIDControls()
        {
            var screenWidth = GetWindowInnerWidth();
            var screenHeight = GetWindowInnerHeight();
        
            var nTextboxLeft = (screenWidth - this.m_nTextboxWidth) / 2;
            var nButtonLeft = (screenWidth - this.m_nButtonWidth) / 2;
            var nTextboxTop = screenHeight / 2 - this.m_nTextboxHeight;
            var nButtonTop = nTextboxTop + this.m_nTextboxHeight + 15;
        
            this.m_nameTextBox.style.left =  nTextboxLeft + "px";
            this.m_nameTextBox.style.top =  nTextboxTop + "px";

            this.m_nameButton.style.left = nButtonLeft + "px";
            this.m_nameButton.style.top = nButtonTop + "px";
        }

        function Start()
        {
            this.m_szName = this.m_nameTextBox.value;

            document.getElementById("NameTextBox").remove();
            document.getElementById("UserNameButton").remove();

            this.m_mode = MODES.RUNNING;

            this.CreateControls();
            this.CreateWebSocket();
        }

        function OnUserNameButtonClick()
        {
            this.m_parent.Start();
        }

        function CreateUserIDControls()
        {
            this.m_nameTextBox = CreateTextbox(10, 10, this.m_nTextboxWidth, this.m_nTextboxHeight, document.body, "", "NameTextBox");
            this.m_nameButton = CreateButton(100,100,this.m_nButtonWidth, this.m_nButtonHeight,document.body,this.OnUserNameButtonClick, "Start", "UserNameButton");

            this.m_nameButton.m_parent = this;

            this.m_nameTextBox.value = "Default Name";

            this.LayoutUserIDControls();
        }

        function CreateWebSocket()
        {
            this.m_websocketConnection = new WebSocket("wss://mobeon.azurewebsites.net");

            this.m_websocketConnection.binaryType = "arraybuffer";

            this.m_websocketConnection.m_parent = this;

            this.m_websocketConnection.onopen = OnWebSocketBinConnectionOpen;
            this.m_websocketConnection.onclose = OnWebSocketBinConnectionClose;
            this.m_websocketConnection.onerror = OnWebSocketConnectionError;
            this.m_websocketConnection.onmessage = OnWebSocketBinConnectionMessage;
        }

        function OnLoad()
        {
            document.body.scroll = "no";
            document.documentElement.style.overflow = 'hidden';
            document.oncontextmenu = function () { return false; };

            CreateUserIDControls();

            //CreateControls();
            //CreateWebSocket();
        }

        function OnSize()
        {
            if(this.m_mode == MODES.STARTING)
            {
                LayoutUserIDControls();
            }
            else
            {
                LayoutControls();
            }
        }

    </script>

  </head>

  <body onLoad="OnLoad()" onresize="OnSize()" style="background-color:#581376">
   
  </body>
</html>
