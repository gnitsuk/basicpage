<!DOCTYPE html>
<html lang="en">
  <head>

    <title>mobeon</title>

    <script type="text/javascript">

        var AWAITING_EVENTS = {"NONE":0, "ACCEPTANCE":1};

        this.m_nButtonWidth = 100;
        this.m_nButtonHeight = 30;
        this.m_sendTextArea = null;
        this.m_arrClientButtons = [];
        this.m_receiveTextArea = null;
        this.m_websocketConnection = null;
        this.m_awaitingEvent = AWAITING_EVENTS.NONE;

        function CreateTextArea(x, y, width, height, parentElement, szInnerHTML, szID)
        {
            var newTextArea = document.createElement("textarea");

            newTextArea.id = szID;
            newTextArea.style.position = "absolute";
            newTextArea.style.left = x.toString() + 'px';
            newTextArea.style.top = y.toString() + 'px';
            newTextArea.style.right = y.toString() + 'px';
            newTextArea.style.width = width.toString() + 'px';
            newTextArea.style.height = height.toString() + 'px';
            newTextArea.type = "text";
            newTextArea.value = szInnerHTML;
            newTextArea.style.resize = "none";
            parentElement.appendChild(newTextArea);

            return newTextArea;
        }

        function CreateButton(x, y, width, height, parentElement, onClickFunction, szInnerHTML, szID)
        {
            var newButton = document.createElement("input");

            newButton.id = szID;
            newButton.style.position = "absolute";
            newButton.style.left = x.toString() + 'px';
            newButton.style.top = y.toString() + 'px';
            newButton.style.width = width.toString() + 'px';
            newButton.style.height = height.toString() + 'px';
            newButton.type = "button";
            newButton.value = szInnerHTML;
            newButton.onclick = onClickFunction;
            parentElement.appendChild(newButton);
    
            return newButton;
        }

        function OnWebSocketBinConnectionMessage(event)
        {
            if (event.data.toString() != "[object ArrayBuffer]")
            {
                var szText = event.data.toString();

                this.m_parent.ProcessIncomingASCIIMessage(szText);
            }
            else
            {
                var dataview = new DataView(event.data);
                 
                var nOpCode = dataview.getInt32(4, true);
                
                var nClientUniqueID = dataview.getInt32(0, true);
                
                if (nOpCode == 0)
                {
                    var x = dataview.getInt32(8, true);
                    var y = dataview.getInt32(12, true);
                }
                else if(nOpCode == 1)
                {
                    //document.title = "X" + Math.random();
                }
            }
        }

        function ProcessIncomingASCIIMessage(szText)
        {
            if (szText.indexOf("Server connection accepted") >= 0)
            {
                document.title = szText;

                this.StartAwaitingAcceptance();
            }
            else
            {
                if(this.m_awaitingEvent = AWAITING_EVENTS.ACCEPTANCE)
                {
                    this.m_receiveTextArea.value = szText;
                }
            }
        }

        function StartAwaitingAcceptance()
        {
            this.m_awaitingEvent = AWAITING_EVENTS.ACCEPTANCE;

            this.m_websocketConnection.send("Name = David");
        }

        function AddClientButton(bLayoutControls)
        {
            var szTextID = "Button " + this.m_arrClientButtons.length.toString();

            this.m_arrClientButtons.push(CreateButton(100,100,this.m_nButtonWidth,this.m_nButtonHeight,document.body,this.OnButtonClick, szTextID, szTextID));

            var nID = this.m_arrClientButtons.length - 1;

            this.m_arrClientButtons[nID].m_parent = this;
            this.m_arrClientButtons[nID].m_clientID = nID;

            if(bLayoutControls)
            {
                LayoutControls();
            }
        }

        function OnButtonClick()
        {
            
        }

        function OnWebSocketBinConnectionClose()
        {
            this.m_parent.m_websocketConnection = null;

            //alert("WS CLOSED");
        }

        function OnWebSocketBinConnectionOpen()
        {
            this.m_parent.AddClientButton(false);
            this.m_parent.LayoutControls();
        }

        function OnWebSocketConnectionError(error)
        {
            //alert("Websocket Error");
        }

        function GetWindowInnerWidth()
        {
            if(window.innerWidth)
            {
                  var innerWidth = window.innerWidth;
            }
            else if(document.documentElement)
            {
                  var innerWidth = document.documentElement.clientWidth;
            }
            else
            {
                  var innerWidth = document.body.clientWidth;
            }

            return innerWidth;
        }

        function GetWindowInnerHeight()
        {
            if(window.innerHeight)
            {
                  var innerHeight = window.innerHeight;
            }
            else if(document.documentElement)
            {
                  var innerHeight = document.documentElement.clientHeight;
            }
            else
            {
                  var innerHeight = document.body.clientHeight;
            }

            return innerHeight;
        }

        function LayoutControls()
        {
            var nBorder = 10;
            var nHalfBorder = nBorder / 2;
            var nTwiceBorder = 2 * nBorder;
            var nThriceBorder = 3 * nBorder;
            var screenWidth = GetWindowInnerWidth();
            var screenHeight = GetWindowInnerHeight();
            var nTextAreaWidth = (screenWidth - nThriceBorder) / 2;
            var receiveTextAreaLeft = nTwiceBorder + nTextAreaWidth;
            var nTextAreaHeight = screenHeight / 3;
        
            this.m_sendTextArea.style.left = nHalfBorder.toString() + "px";
            this.m_sendTextArea.style.width = nTextAreaWidth.toString() + "px";
            this.m_sendTextArea.style.height = nTextAreaHeight.toString() + "px";

            this.m_receiveTextArea.style.left = receiveTextAreaLeft.toString() + "px";
            this.m_receiveTextArea.style.width = nTextAreaWidth.toString() + "px";
            this.m_receiveTextArea.style.height = nTextAreaHeight.toString() + "px";

            var buttonRow1Top = nThriceBorder + nTextAreaHeight;
        
            for(var nButton = 0; nButton < this.m_arrClientButtons.length; nButton++)
            {
                var nButtonLeft = nThriceBorder + nButton * (this.m_nButtonWidth + nBorder);

                this.m_arrClientButtons[nButton].style.top = buttonRow1Top.toString() + "px";
                this.m_arrClientButtons[nButton].style.left = nButtonLeft.toString() + "px";
            }
        }

        function CreateControls()
        {
            this.m_sendTextArea = CreateTextArea(10, 10, 400, 100, document.body, "", "SentMessagesTextArea");
            this.m_receiveTextArea = CreateTextArea(10, 10, 400, 100, document.body, "", "ReceiveMessagesTextArea");

            LayoutControls();
        }

        function CreateWebSocket()
        {
            this.m_websocketConnection = new WebSocket("wss://mobeon.azurewebsites.net");

            this.m_websocketConnection.binaryType = "arraybuffer";

            this.m_websocketConnection.m_parent = this;

            this.m_websocketConnection.onopen = OnWebSocketBinConnectionOpen;
            this.m_websocketConnection.onclose = OnWebSocketBinConnectionClose;
            this.m_websocketConnection.onerror = OnWebSocketConnectionError;
            this.m_websocketConnection.onmessage = OnWebSocketBinConnectionMessage;
        }

        function OnLoad()
        {
            document.body.scroll = "no";
            document.documentElement.style.overflow = 'hidden';
            document.oncontextmenu = function () { return false; };

            CreateControls();
            CreateWebSocket();
        }

        function OnSize()
        {
            LayoutControls();
        }

    </script>

  </head>

  <body onLoad="OnLoad()" onresize="OnSize()" style="background-color:#FF0000">
   
  </body>
</html>
